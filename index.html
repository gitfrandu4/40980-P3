<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, user-scalable=no" />
        <style>
            body,
            html {
                overflow: hidden;
                width: 100%;

                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            }
            #my_Canvas {
                border: 1px solid black;
                margin: 0 auto;
                border-radius: 10px;
                box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.5);
                background-color: #f0f0f0;
                display: block;
            }
        </style>
        <h1>Informática Gráfica</h1>
        <h2>Practica 3</h2>
        <p>Francisco Javier López-Dufour Morales</p>
    </head>

    <body>
        <canvas style="min-height: 50%" width="350" height="350" id="my_Canvas"></canvas>

        <script id="vertex-shader" type="x-shader/x-vertex">
            #version 300 es
            precision mediump float;

            in vec2 aCoordinates; // Receive coordinates from the buffer
            out vec2 vCoordinates; // Pass coordinates to fragment shader

            void main(void) {
              gl_Position = vec4(aCoordinates, 0, 1);
              vCoordinates = aCoordinates;
            }
        </script>

        <script id="fragment-shader" type="x-shader/x-fragment">
            #version 300 es
            precision mediump float;

            uniform vec4 uColor; // Receive color from the program
            in vec2 vCoordinates; // Receive coordinates from vertex shader
            out vec4 fragColor; // Output color

            void main(void) {
              fragColor = uColor;
            }
        </script>

        <script>
            var ball = {
                shape: 'circle',
                x: -0.05,
                y: -0.05,
                width: 0.1,
                height: 0.1,
                color: [0, 0, 1, 1],
                speedX: 0,
                speedY: 0,
            };

            var player1 = {
                shape: 'rectangle',
                x: -0.9,
                y: -0.2,
                width: 0.1,
                height: 0.4,
                color: [0.9, 0.2, 0.4, 1],
                movement: 0,
                score: 0,
                scoreHistory: [],
            };

            function init() {
                // ============ STEP 1: Creating a canvas=================
                canvas = document.getElementById('my_Canvas');
                gl = canvas.getContext('webgl2');

                if (!gl) {
                    console.error('WebGL no está disponible');
                }

                //========== STEP 2: Create and compile shaders ==========

                // Create a vertex shader object
                var vertShader = gl.createShader(gl.VERTEX_SHADER);

                // Attach vertex shader source code
                var script = document.getElementById('vertex-shader');
                var shaderString = script.text.trim();
                gl.shaderSource(vertShader, shaderString);

                // Compile the vertex shader
                gl.compileShader(vertShader);

                // Create fragment shader object
                var fragShader = gl.createShader(gl.FRAGMENT_SHADER);

                // Attach fragment shader source code
                script = document.getElementById('fragment-shader');
                shaderString = script.text.trim();
                gl.shaderSource(fragShader, shaderString);

                // Compile the fragment shader
                gl.compileShader(fragShader);

                // Create a shader program object to store the combined shader program
                var shaderProgram = gl.createProgram();

                // Attach a vertex shader
                gl.attachShader(shaderProgram, vertShader);

                // Attach a fragment shader
                gl.attachShader(shaderProgram, fragShader);

                // Link both programs
                gl.linkProgram(shaderProgram);

                // Use the combined shader program object
                gl.useProgram(shaderProgram);

                //======== STEP 3: Create buffer objects and associate shaders ========

                // Create an empty buffer object to store the vertex buffer
                var vertex_buffer = gl.createBuffer();

                // Bind vertex buffer object
                gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);

                // Get the attribute location
                var coordLocation = gl.getAttribLocation(shaderProgram, 'aCoordinates');

                // Point an attribute to the currently bound VBO
                gl.vertexAttribPointer(coordLocation, 2, gl.FLOAT, false, 0, 0);

                // Enable the attribute
                gl.enableVertexAttribArray(coordLocation);

                // look up uniform locations
                colorLocation = gl.getUniformLocation(shaderProgram, 'uColor');

                render();
            }

            function render() {
                //========= STEP 4: Create the geometry and draw ===============
                // Clear the canvas
                gl.clearColor(0.1, 0.2, 0.3, 1.0);

                // Clear the color buffer bit
                gl.clear(gl.COLOR_BUFFER_BIT);

                // Set the view port
                gl.viewport(0, 0, canvas.width, canvas.height);

                drawShapePong(ball.shape, ball);
                drawShapePong(player1.shape, player1);

                // Bounce ball off the right side of the canvas
                if (ball.x + ball.width > 1) {
                    ball.speedX = -ball.speedX;
                }

                // Reset ball position if it goes out of the left side of the canvas
                if (ball.x < -0.95) {
                    resetBall();
                    updateScoreHistory();
                    resetPlayer();
                }

                // Bounce ball off the top and bottom of the canvas
                if (ball.y + ball.height > 1 || ball.y < -1) {
                    ball.speedY = -ball.speedY;
                }

                // Stop the players if they reach the edges of the canvas
                if (player1.y + player1.height > 1 && player1.movement > 0) {
                    player1.movement = 0;
                }
                if (player1.y < -1 && player1.movement < 0) {
                    player1.movement = 0;
                }

                // If the ball collides with the player, change its direction
                if (
                    ball.x < -0.8 && // ball is on the left side of the canvas with a small margin
                    ball.x + ball.width > player1.x &&
                    ball.x < player1.x + player1.width &&
                    ball.y + ball.height > player1.y &&
                    ball.y < player1.y + player1.height
                ) {
                    ball.speedX = -ball.speedX;
                    updateScore();
                    updateSpeed();
                }

                // animate ball
                ball.x += ball.speedX;
                ball.y += ball.speedY;

                // Update player positions
                player1.y += player1.movement;

                // start animation loop
                window.requestAnimationFrame(render);
            }

            window.onload = init;

            function drawShape(shape, x, y, size, color) {
                if (shape === 'rectangle') {
                    drawRectangle(x, y, size[0], size[1], color);
                } else if (shape === 'triangle') {
                    drawTriangle(x, y, size[0], color);
                }
            }

            function drawShapePong(shape, figure) {
                if (shape === 'rectangle') {
                    drawRectangle(figure.x, figure.y, figure.width, figure.height, figure.color);
                } else if (shape === 'circle') {
                    drawCircle(figure.x, figure.y, figure.width, figure.height, figure.color);
                }
            }

            function drawRectangle(x, y, width, height, color) {
                var x1 = x;
                var x2 = x + width;
                var y1 = y;
                var y2 = y + height;
                gl.bufferData(
                    gl.ARRAY_BUFFER,
                    new Float32Array([x1, y1, x2, y1, x1, y2, x1, y2, x2, y1, x2, y2]),
                    gl.STATIC_DRAW,
                );
                gl.uniform4fv(colorLocation, color);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
            }

            function drawTriangle(x, y, size, color) {
                gl.bufferData(
                    gl.ARRAY_BUFFER,
                    new Float32Array([x, y, x + size, y, x, y + size]),
                    gl.STATIC_DRAW,
                );
                gl.uniform4fv(colorLocation, color);
                gl.drawArrays(gl.TRIANGLES, 0, 3);
            }

            function drawCircle(x, y, width, height, color) {
                var x1 = x;
                var x2 = x + width;
                var y1 = y;
                var y2 = y + height;

                gl.bufferData(
                    gl.ARRAY_BUFFER,
                    new Float32Array([x1, y1, x2, y1, x1, y2, x1, y2, x2, y1, x2, y2]),
                    gl.STATIC_DRAW,
                );
                gl.uniform4fv(colorLocation, color);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
            }

            function setColor(color) {
                currentColor = color;
            }

            function setDirection(newDirection) {
                direction = newDirection;
            }

            // Process key events by updating global orientation values
            function onKeyDown(key) {
                switch (key.keyCode) {
                    // up arrow
                    case 38: {
                        player1.movement = 0.02;
                        break;
                    }
                    // down arrow
                    case 40: {
                        player1.movement = -0.02;
                        break;
                    }
                    // space
                    case 32: {
                        start();
                        break;
                    }
                }
            }

            function onKeyUp(key) {
                player1.movement = 0;
            }

            // eventos en el móvil
            function onTouchStart(e) {
                touchobj = e.changedTouches[0]; // reference first touch
                prevTouchY = parseInt(touchobj.clientY);
            }

            function onTouchMove(e) {
                touchobj = e.changedTouches[0]; // reference first touch
                touchY = parseInt(touchobj.clientY);
                difY = touchY - prevTouchY;
                player1.movement = -difY * 0.0005;
                prevTouchY = touchY;
            }

            function onTouchEnd(e) {
                player1.movement = 0;
            }

            // Keyboard controls
            window.addEventListener('keydown', onKeyDown);
            window.addEventListener('keyup', onKeyUp);

            // Mobile controls
            var canvas = document.getElementById('my_Canvas');
            canvas.addEventListener('touchmove', onTouchMove, false);
            canvas.addEventListener('touchstart', onTouchStart, false);
            canvas.addEventListener('touchend', onTouchEnd, false);

            document.getElementById('start').addEventListener('click', start);

            function start() {
                resetBall();
                resetPlayer();
                updateSpeed();
            }

            function updateScore() {
                player1.score += 1;
                document.querySelector('.score p').textContent = `Puntuación: ${player1.score}`;
            }

            function updateSpeed() {
                ball.speedX = 0.02 + player1.score * 0.002;
                ball.speedY = Math.random() * 0.04 - 0.02; // Random value between -0.02 and 0.02
            }

            function resetPlayer() {
                player1.y = 0 - player1.height / 2;
                player1.movement = 0;
                player1.score = 0;
            }

            function resetBall() {
                ball.speedX = 0;
                ball.speedY = 0;

                ball.x = 0 - ball.width / 2;
                ball.y = 0 - ball.height / 2;
            }

            function updateScoreHistory() {
                var scoreHistoryList = document.getElementById('score-history-list');
                var listItem = document.createElement('li');

                listItem.textContent = `Juego ${player1.scoreHistory.length + 1}: ${player1.score}`;
                scoreHistoryList.insertBefore(listItem, scoreHistoryList.firstChild);

                player1.scoreHistory.push(player1.score);
            }
        </script>
    </body>
</html>
